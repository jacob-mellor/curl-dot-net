name: .NET Framework Compatibility

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master ]

jobs:
  test-framework:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET Framework
      uses: microsoft/setup-msbuild@v1.1

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          8.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build for .NET Framework 4.7.2
      run: |
        dotnet build src/CurlDotNet/CurlDotNet.csproj -c Release -f net472
        dotnet build src/CurlDotNet/CurlDotNet.csproj -c Release -f net48

    - name: Test Framework Compatibility with .NET Standard 2.0
      run: |
        dotnet test tests/CurlDotNet.FrameworkCompat/CurlDotNet.FrameworkCompat.csproj -c Release

    - name: Create Framework Test Console App
      run: |
        mkdir FrameworkTest
        cd FrameworkTest
        dotnet new console -f net472
        dotnet add package CurlDotNet --source ../src/CurlDotNet/bin/Release

    - name: Test Framework Console App
      run: |
        cd FrameworkTest
        echo 'using CurlDotNet; var curl = new Curl(); var result = curl.Execute("curl https://httpbin.org/get"); Console.WriteLine(result.StatusCode);' > Program.cs
        dotnet build
        dotnet run