name: Deploy NuGet

on:
  # Trigger when code is pushed to main/master branch
  push:
    branches: [ main, master ]

  # Allow manual trigger for emergency deployments
  workflow_dispatch:

jobs:
  deploy-nuget:
    name: Build and Deploy to NuGet
    runs-on: windows-latest  # MUST use Windows for .NET Framework 4.7.2 and 4.8 support

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup .NET 9.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup MSBuild (for .NET Framework)
      uses: microsoft/setup-msbuild@v2

    - name: Restore dependencies
      run: dotnet restore

    - name: Build and Pack NuGet Package
      run: |
        dotnet build src/CurlDotNet/CurlDotNet.csproj --configuration Release --no-restore
        dotnet pack src/CurlDotNet/CurlDotNet.csproj --configuration Release --no-build --output ./nupkg

    - name: Verify Package
      shell: pwsh
      run: |
        $package = Get-ChildItem -Path "./nupkg" -Filter "*.nupkg" | Where-Object { $_.Name -notlike "*.symbols.*" } | Select-Object -First 1

        if (-not $package) {
            Write-Error "No NuGet package found!"
            exit 1
        }

        Write-Host "ðŸ“¦ Found package: $($package.Name)"

        # Extract and verify the package contains all target frameworks
        $extractPath = Join-Path $env:TEMP "verify-pkg"
        New-Item -ItemType Directory -Path $extractPath -Force | Out-Null

        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($package.FullName, $extractPath)

        $requiredFrameworks = @(
            "lib/netstandard2.0/CurlDotNet.dll",
            "lib/net472/CurlDotNet.dll",
            "lib/net48/CurlDotNet.dll",
            "lib/net8.0/CurlDotNet.dll",
            "lib/net9.0/CurlDotNet.dll"
        )

        foreach ($framework in $requiredFrameworks) {
            $path = Join-Path $extractPath $framework
            if (-not (Test-Path $path)) {
                Write-Error "Missing required framework: $framework"
                exit 1
            }
            Write-Host "âœ… Found: $framework"
        }

        Write-Host "âœ… Package verification passed!"

    - name: Push to NuGet.org
      run: |
        dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

    - name: Report Success
      if: success()
      run: |
        echo "========================================="
        echo "âœ… NuGet package deployed successfully!"
        echo "========================================="
        echo ""
        echo "ðŸ“¦ View package at:"
        echo "   https://www.nuget.org/packages/CurlDotNet"
        echo ""
        echo "Note: It may take 5-10 minutes for the package to be indexed"