name: Automated Documentation & Build Maintenance

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  auto-fix-documentation:
    name: Auto-Fix Documentation Structure
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install DocFX
      run: |
        dotnet tool install -g docfx
        echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

    - name: Auto-create missing index files
      run: |
        echo "ðŸ”§ Auto-creating missing documentation index files..."

        # Create index for any directory missing one
        for dir in docs/*/ docs/*/*/ docs/*/*/*/; do
          if [ -d "$dir" ] && [ ! -f "$dir/README.md" ] && [ ! -f "$dir/index.md" ]; then
            echo "Creating index for $dir"

            dirname=$(basename "$dir")
            title=$(echo "$dirname" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')

            cat > "$dir/README.md" << EOF
        # $title

        This section contains documentation for $title.

        ## Contents

        EOF

            # List files in directory
            for file in "$dir"*.md; do
              if [ -f "$file" ] && [ "$(basename "$file")" != "README.md" ]; then
                filename=$(basename "$file" .md)
                echo "- [$filename]($filename.md)" >> "$dir/README.md"
              fi
            done

            # List subdirectories
            for subdir in "$dir"*/; do
              if [ -d "$subdir" ]; then
                subdirname=$(basename "$subdir")
                echo "- [$subdirname]($subdirname/)" >> "$dir/README.md"
              fi
            done
          fi
        done

    - name: Auto-clean documentation artifacts from master
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      run: |
        echo "ðŸ§¹ Auto-cleaning documentation artifacts..."

        # Remove any built documentation files
        find . -name "*.html" -not -path "./.git/*" -not -path "./docs/*" -delete 2>/dev/null || true
        find . -name "*.min.js" -not -path "./.git/*" -not -path "./node_modules/*" -delete 2>/dev/null || true
        find . -name "*.min.css" -not -path "./.git/*" -not -path "./node_modules/*" -delete 2>/dev/null || true
        rm -rf _site docs/_site build/docfx/_site 2>/dev/null || true

        # Remove docfx artifacts from docs
        rm -f docs/manifest.json docs/xrefmap.yml docs/index.json 2>/dev/null || true
        rm -f docs/*.html docs/toc.* 2>/dev/null || true
        rm -rf docs/public 2>/dev/null || true

    - name: Auto-generate sitemap
      run: |
        echo "ðŸ—ºï¸ Auto-generating sitemap..."

        cat > sitemap.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
        EOF

        BASE_URL="https://jacob-mellor.github.io/curl-dot-net"
        DATE=$(date +%Y-%m-%d)

        # Add all documentation files
        find docs -name "*.md" -type f | while read -r file; do
          path=${file#docs/}
          url_path=$(echo "$path" | sed 's/\.md$/\.html/g' | sed 's/README\.html/index.html/g')

          cat >> sitemap.xml << EOF
          <url>
            <loc>$BASE_URL/manual/$url_path</loc>
            <lastmod>$DATE</lastmod>
            <changefreq>weekly</changefreq>
            <priority>0.5</priority>
          </url>
        EOF
        done

        echo "</urlset>" >> sitemap.xml

    - name: Commit auto-fixes if needed
      run: |
        git config --global user.name "Documentation Bot"
        git config --global user.email "bot@github.com"

        if [ -n "$(git status --porcelain)" ]; then
          echo "ðŸ“ Committing automatic fixes..."
          git add -A
          git commit -m "ðŸ¤– Auto-fix: Documentation structure and cleanup

        - Created missing index files
        - Removed build artifacts from master
        - Generated/updated sitemap
        - Automated by GitHub Actions"

          git push origin HEAD
        else
          echo "âœ… No fixes needed"
        fi

  docker-build-validation:
    name: Validate Docker Builds
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create Dockerfile if missing
      run: |
        if [ ! -f "Dockerfile" ]; then
          echo "ðŸ“¦ Creating Dockerfile..."

          cat > Dockerfile << 'EOF'
        # Multi-stage build for CurlDotNet
        FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
        WORKDIR /src

        # Copy project files
        COPY src/CurlDotNet/CurlDotNet.csproj ./CurlDotNet/
        RUN dotnet restore "CurlDotNet/CurlDotNet.csproj"

        # Copy source code
        COPY src/ .

        # Build
        WORKDIR /src/CurlDotNet
        RUN dotnet build -c Release -o /app/build

        # Publish
        FROM build AS publish
        RUN dotnet publish -c Release -o /app/publish /p:UseAppHost=false

        # Final runtime image
        FROM mcr.microsoft.com/dotnet/runtime:8.0 AS final
        WORKDIR /app
        COPY --from=publish /app/publish .

        # Health check
        HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
          CMD dotnet --info || exit 1

        ENTRYPOINT ["dotnet", "CurlDotNet.dll"]
        EOF

          git config --global user.name "Docker Bot"
          git config --global user.email "bot@github.com"
          git add Dockerfile
          git commit -m "ðŸ³ Auto-create Dockerfile for automated builds"
          git push origin HEAD
        fi

    - name: Create docker-compose if missing
      run: |
        if [ ! -f "docker-compose.yml" ]; then
          echo "ðŸ³ Creating docker-compose.yml..."

          cat > docker-compose.yml << 'EOF'
        version: '3.8'

        services:
          curldotnet:
            build:
              context: .
              dockerfile: Dockerfile
            image: curldotnet:latest
            container_name: curldotnet
            environment:
              - ASPNETCORE_ENVIRONMENT=Production
            restart: unless-stopped
            networks:
              - curldotnet-network

          docs:
            build:
              context: .
              dockerfile: Dockerfile.docs
            image: curldotnet-docs:latest
            container_name: curldotnet-docs
            ports:
              - "8080:80"
            restart: unless-stopped
            networks:
              - curldotnet-network

        networks:
          curldotnet-network:
            driver: bridge
        EOF

          cat > Dockerfile.docs << 'EOF'
        FROM nginx:alpine
        COPY docs/_site /usr/share/nginx/html
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF

          git add docker-compose.yml Dockerfile.docs
          git commit -m "ðŸ³ Auto-create docker-compose for orchestration"
          git push origin HEAD
        fi

    - name: Test Docker build
      run: |
        echo "ðŸ”¨ Testing Docker build..."
        docker build -t curldotnet-test:${{ github.sha }} .

    - name: Test Docker Compose
      run: |
        if [ -f "docker-compose.yml" ]; then
          echo "ðŸ”¨ Testing Docker Compose..."
          docker-compose build
        fi

  auto-deploy-docs:
    name: Auto-Deploy Documentation
    runs-on: ubuntu-latest
    needs: [auto-fix-documentation]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install DocFX
      run: |
        dotnet tool install -g docfx
        echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

    - name: Build project
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: Build documentation
      run: |
        # Ensure build/docfx exists
        mkdir -p build/docfx/api

        # Create docfx.json if missing
        if [ ! -f "build/docfx/docfx.json" ]; then
          cp .github/templates/docfx.json build/docfx/ 2>/dev/null || cat > build/docfx/docfx.json << 'EOF'
        {
          "$schema": "http://dotnet.github.io/docfx/schemas/v2/config.schema.json",
          "metadata": [{
            "src": [{"files": ["src/CurlDotNet/CurlDotNet.csproj"], "src": "../.."}],
            "dest": "api"
          }],
          "build": {
            "content": [
              {"files": ["api/**.yml", "api/index.md"]},
              {"files": ["**.md", "**/**.md"], "src": "../../docs", "dest": "manual"},
              {"files": ["toc.yml", "index.md"]}
            ],
            "resource": [{"files": ["images/**"], "src": "../../docs"}],
            "dest": "_site",
            "template": ["default", "modern"],
            "postProcessors": ["ExtractSearchIndex", "SitemapGenerator"],
            "globalMetadata": {
              "_appName": "CurlDotNet",
              "_appTitle": "CurlDotNet - Pure .NET curl",
              "_enableSearch": true
            },
            "sitemap": {"baseUrl": "https://jacob-mellor.github.io/curl-dot-net"}
          }
        }
        EOF
        fi

        # Create required files
        [ ! -f "build/docfx/index.md" ] && echo "# CurlDotNet" > build/docfx/index.md
        [ ! -f "build/docfx/toc.yml" ] && echo "- name: Manual\n  href: manual/\n- name: API\n  href: api/" > build/docfx/toc.yml
        [ ! -f "build/docfx/api/index.md" ] && echo "# API Reference" > build/docfx/api/index.md

        # Build
        cd build/docfx
        docfx metadata
        docfx build

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build/docfx/_site
        publish_branch: gh-pages
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'ðŸš€ Auto-deploy documentation from ${{ github.sha }}'
        cname: ''
        exclude_assets: '.github,scripts,tests,samples,src,*.cs,*.csproj,*.sln'

  auto-cleanup-branches:
    name: Auto-Cleanup Branches
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Auto-clean gh-pages
      run: |
        echo "ðŸ§¹ Auto-cleaning gh-pages branch..."

        git checkout gh-pages || exit 0

        # Remove any source files
        find . -name "*.cs" -delete 2>/dev/null || true
        find . -name "*.csproj" -delete 2>/dev/null || true
        find . -name "*.sln" -delete 2>/dev/null || true
        rm -rf src tests scripts 2>/dev/null || true

        if [ -n "$(git status --porcelain)" ]; then
          git config --global user.name "Cleanup Bot"
          git config --global user.email "bot@github.com"
          git add -A
          git commit -m "ðŸ§¹ Auto-cleanup: Remove source files from gh-pages"
          git push origin gh-pages
        fi

  notification:
    name: Status Notification
    runs-on: ubuntu-latest
    needs: [auto-fix-documentation, docker-build-validation, auto-deploy-docs]
    if: always()

    steps:
    - name: Create status summary
      run: |
        echo "## ðŸ¤– Automated Maintenance Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Documentation Fix | ${{ needs.auto-fix-documentation.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Validation | ${{ needs.docker-build-validation.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docs Deployment | ${{ needs.auto-deploy-docs.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All maintenance tasks completed automatically. No manual intervention required." >> $GITHUB_STEP_SUMMARY