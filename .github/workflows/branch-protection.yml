name: Branch Protection Validator

on:
  push:
    branches: [ master, gh-pages ]
  pull_request:
    branches: [ master, gh-pages ]
  schedule:
    - cron: '0 0 * * *'  # Daily check at midnight UTC
  workflow_dispatch:

jobs:
  validate-master:
    name: Validate Master Branch
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.base_ref == 'master'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for documentation artifacts
      run: |
        echo "ðŸ” Checking master branch for documentation contamination..."

        # Check for built HTML files (excluding README files)
        HTML_COUNT=$(find . -name "*.html" -not -name "README.html" -not -path "./.git/*" | wc -l || echo 0)
        if [ "$HTML_COUNT" -gt 0 ]; then
          echo "âŒ Found $HTML_COUNT HTML files in master branch!"
          find . -name "*.html" -not -path "./.git/*" | head -20
          exit 1
        fi

        # Check for _site directories
        if [ -d "_site" ] || [ -d "docs/_site" ] || [ -d "build/docfx/_site" ]; then
          echo "âŒ Found _site directory in master branch!"
          exit 1
        fi

        # Check for minified JS/CSS
        MINIFIED=$(find . \( -name "*.min.js" -o -name "*.min.css" \) -not -path "./.git/*" -not -path "./node_modules/*" | wc -l || echo 0)
        if [ "$MINIFIED" -gt 0 ]; then
          echo "âŒ Found $MINIFIED minified files in master branch!"
          exit 1
        fi

        # Check for DocFX artifacts
        if [ -f "docs/manifest.json" ] || [ -f "docs/xrefmap.yml" ] || [ -f "docs/index.json" ]; then
          echo "âŒ Found DocFX build artifacts in docs/"
          exit 1
        fi

        echo "âœ… Master branch is clean"

    - name: Verify source code exists
      run: |
        echo "ðŸ” Verifying source code presence..."

        # Check for essential source files
        if [ ! -f "src/CurlDotNet/CurlDotNet.csproj" ]; then
          echo "âŒ Missing CurlDotNet.csproj"
          exit 1
        fi

        if [ ! -d "tests" ]; then
          echo "âŒ Missing tests directory"
          exit 1
        fi

        CS_COUNT=$(find src -name "*.cs" | wc -l || echo 0)
        if [ "$CS_COUNT" -lt 10 ]; then
          echo "âŒ Too few C# files found: $CS_COUNT"
          exit 1
        fi

        echo "âœ… Source code structure verified"

  validate-gh-pages:
    name: Validate gh-pages Branch
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/gh-pages' || github.base_ref == 'gh-pages'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for source code contamination
      run: |
        echo "ðŸ” Checking gh-pages branch for source code..."

        # Check for C# files
        CS_COUNT=$(find . -name "*.cs" -not -path "./.git/*" | wc -l || echo 0)
        if [ "$CS_COUNT" -gt 0 ]; then
          echo "âŒ Found $CS_COUNT C# files in gh-pages branch!"
          find . -name "*.cs" | head -20
          exit 1
        fi

        # Check for project files
        PROJ_COUNT=$(find . \( -name "*.csproj" -o -name "*.sln" \) | wc -l || echo 0)
        if [ "$PROJ_COUNT" -gt 0 ]; then
          echo "âŒ Found $PROJ_COUNT project files in gh-pages!"
          exit 1
        fi

        # Check for source directories
        if [ -d "src" ] || [ -d "tests" ]; then
          echo "âŒ Found source directories in gh-pages!"
          exit 1
        fi

        # Check for build scripts
        SCRIPT_COUNT=$(find . -name "*.sh" -not -path "./.git/*" | wc -l || echo 0)
        if [ "$SCRIPT_COUNT" -gt 0 ]; then
          echo "âš ï¸  Found $SCRIPT_COUNT shell scripts in gh-pages"
          find . -name "*.sh" | head -10
        fi

        echo "âœ… gh-pages branch contains only documentation"

    - name: Verify documentation structure
      run: |
        echo "ðŸ” Verifying documentation structure..."

        # Check for essential files
        if [ ! -f "index.html" ]; then
          echo "âŒ Missing index.html"
          exit 1
        fi

        if [ ! -f ".nojekyll" ]; then
          echo "âš ï¸  Missing .nojekyll file"
        fi

        HTML_COUNT=$(find . -name "*.html" -not -path "./.git/*" | wc -l || echo 0)
        if [ "$HTML_COUNT" -lt 5 ]; then
          echo "âš ï¸  Only $HTML_COUNT HTML files found"
        fi

        echo "âœ… Documentation structure verified"

  cross-branch-check:
    name: Cross-Branch Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Setup Git
      run: |
        git config --global user.name "Branch Validator"
        git config --global user.email "action@github.com"

    - name: Clone repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Compare branches
      run: |
        echo "ðŸ“Š Branch Comparison Report"
        echo "=========================="

        # Analyze master
        git checkout master
        MASTER_CS=$(find . -name "*.cs" -not -path "./.git/*" | wc -l || echo 0)
        MASTER_HTML=$(find . -name "*.html" -not -path "./.git/*" | wc -l || echo 0)
        MASTER_SIZE=$(du -sh . | cut -f1)

        # Analyze gh-pages
        git checkout gh-pages
        GHPAGES_CS=$(find . -name "*.cs" -not -path "./.git/*" | wc -l || echo 0)
        GHPAGES_HTML=$(find . -name "*.html" -not -path "./.git/*" | wc -l || echo 0)
        GHPAGES_SIZE=$(du -sh . | cut -f1)

        echo ""
        echo "Master Branch:"
        echo "  - C# files: $MASTER_CS"
        echo "  - HTML files: $MASTER_HTML"
        echo "  - Total size: $MASTER_SIZE"
        echo ""
        echo "gh-pages Branch:"
        echo "  - C# files: $GHPAGES_CS"
        echo "  - HTML files: $GHPAGES_HTML"
        echo "  - Total size: $GHPAGES_SIZE"
        echo ""

        # Validate results
        if [ "$MASTER_HTML" -gt 10 ]; then
          echo "âš ï¸  Master has too many HTML files"
        fi

        if [ "$GHPAGES_CS" -gt 0 ]; then
          echo "âŒ gh-pages contains source code!"
          exit 1
        fi

        if [ "$MASTER_CS" -eq 0 ]; then
          echo "âŒ Master has no C# files!"
          exit 1
        fi

        echo ""
        echo "âœ… Branch separation validated successfully"

    - name: Create validation report
      if: always()
      run: |
        DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        cat > validation-report.md << EOF
        # Branch Validation Report
        Date: $DATE

        ## Status
        - Master: ${{ job.status }}
        - gh-pages: ${{ job.status }}

        ## Recommendations
        - Keep documentation sources in master:/docs
        - Keep built documentation in gh-pages
        - Never commit _site directories
        - Use deployment scripts for updates
        EOF

        echo "Report generated: validation-report.md"